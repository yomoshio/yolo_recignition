from ultralytics import YOLO


def optimize_hyperparameters(dataset_yaml, experiment_name, experiment_dir, iteration=1):
    model_default = YOLO("../yolo11s.pt")
    model_upgrade = YOLO(experiment_dir / "baseline9/weights/best.pt")
    if iteration == 1:
        results = model_default.train(
            data=dataset_yaml,
            epochs=100,
            batch=4,
            imgsz=640,
            name=f"{experiment_name}_opt1",
            device=0, 
            workers=4,
            patience=15,
            optimizer="SGD",
            lr0=0.005,
            lrf=0.00005,
            momentum=0.9,
            weight_decay=0.0005,
            cos_lr=True,
            freeze=10,
            hsv_h=0.02,
            hsv_s=0.8,
            hsv_v=0.5,
            degrees=45.0,
            translate=0.3,
            scale=1.0,
            shear=0.3,
            perspective=0.002,
            flipud=0.5,
            fliplr=0.5,
            mosaic=1.0,
            mixup=0.3,
            auto_augment="randaugment",
            multi_scale=True,
            val=True
        )
    elif iteration == 2:
        results = model_default.train(
            data=dataset_yaml,
            epochs=100,
            batch=4,
            imgsz=640,
            name=f"{experiment_name}_opt2",
            device=0, 
            workers=4,
            patience=15,
            optimizer="AdamW",
            lr0=0.0005,
            lrf=0.00001,
            momentum=0.937,
            weight_decay=0.0001,
            cos_lr=True,
            freeze=15,
            hsv_h=0.025,
            hsv_s=0.9,
            hsv_v=0.6,
            degrees=60.0,
            translate=0.4,
            scale=0.9,
            shear=0.4,
            perspective=0.003,
            flipud=0.5,
            fliplr=0.5,
            mosaic=1.0,
            mixup=0.4,
            auto_augment="randaugment",
            multi_scale=True,
            val=True
        )
    elif iteration == 3:
        results = model_upgrade.train(
            data=dataset_yaml,
            epochs=100,
            batch=4,
            imgsz=640,
            name=f"{experiment_name}_opt3",
            device=0, 
            workers=4,
            patience=15,
            optimizer="AdamW",
            lr0=0.0005,
            lrf=0.00001,
            momentum=0.937,
            weight_decay=0.0001,
            cos_lr=True,
            freeze=15,
            hsv_h=0.025,
            hsv_s=0.9,
            hsv_v=0.6,
            degrees=60.0,
            translate=0.4,
            scale=0.9,
            shear=0.4,
            perspective=0.003,
            flipud=0.5,
            fliplr=0.5,
            mosaic=1.0,
            mixup=0.4,
            auto_augment="randaugment",
            multi_scale=True,
            val=True
        )
    elif iteration == 4:
        results = model_upgrade.train(
            data=dataset_yaml,
            epochs=100,
            batch=4,
            imgsz=640,
            name=f"{experiment_name}_opt4",
            device=0,  
            workers=4,
            patience=15,
            optimizer="AdamW",
            lr0=0.0005,
            lrf=0.00001,
            momentum=0.937,
            weight_decay=0.0001,
            cos_lr=True,
            freeze=15,
            hsv_h=0.025,
            hsv_s=0.9,
            hsv_v=0.6,
            degrees=60.0,
            translate=0.4,
            scale=0.9,
            shear=0.4,
            perspective=0.003,
            flipud=0.5,
            fliplr=0.5,
            mosaic=1.0,
            mixup=0.4,
            auto_augment="randaugment",
            multi_scale=True,
            val=True
        )
    return results