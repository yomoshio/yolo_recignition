# Система детекции блюд с использованием YOLOv11


## Запуск в тестовом режиме 

1. Подготовка видеофайлов
Перед непосредственным запуском необходимо:

Заполнить папку videos/ видеофайлами в формате .MOV
Для примера все видео были скачаны с https://disk.yandex.ru/d/-VhiX2BOWdw-rg и переименованы - 

    1.mov -> "videos/video1.mov"
    2_1.mov -> "videos/video2.mov"
    3_1.mov -> "videos/video3.mov"
    3_2.mov -> "videos/video4.mov"
    4_1.mov -> "videos/video5.mov"
    4.mov -> "videos/video6.mov"

Изменить список путей к видео в файле main.py:

pythonvideo_paths = [
    base_dir / "videos/video1.mov",
    base_dir / "videos/video2.mov", 
    base_dir / "videos/video3.mov",
    base_dir / "videos/video4.mov",
    base_dir / "videos/video5.mov",
    base_dir / "videos/video6.mov",
]

Для теста с заранее созданными аннотациями обязательно назвать их так и в таком порядке для корректной аннотации и аугментации.

2. Распаковка аннотаций
Распакуйте архив с аннотациями annotations/annotations.zip в ту же папку annotations/.

3. Выполнение пайплайна
Выполните все пункты по порядку от 1 до 11 в интерактивном меню для полной проверки работы системы.
Настоятельно рекомендуется перед запуском прочитать полный отчет (файл .pdf в корневой директории).

Вы можете найти описание каждого действия в разделе "Использование"


## Содержание репозитория

Репозиторий содержит все необходимое для запуска:

Все аннотации, выполненные вручную в формате YOLO
Все модели, полученные в результате обучения в папке experiments
Пример готового видео хранится на MEGA - https://mega.nz/file/v9QEgaQJ#5fQR3mo1L6_uNYH5gtsoUIUhwbWQGPqC8CTJSpeCUBU


## Описание проекта

Этот проект представляет собой систему автоматической детекции блюд и посуды на основе компьютерного зрения с использованием архитектуры YOLOv11. Система способна распознавать 11 различных классов объектов в видеопотоке с высокой точностью (mAP@0.5 = 0.988).


## Опыт с YOLOV11 - ДА

## Время выполнения около 50 часов

## Классы объектов

Система обучена распознавать следующие 11 классов:

| ID | Класс | Описание |
|----|-------|----------|
| 0 | steak | Мясное блюдо (стейк) |
| 1 | salad | Салат |
| 2 | soup | Суп |
| 3 | cake | Лепешка |
| 4 | tea | Чай |
| 5 | empty_plate_steak | Пустая тарелка после стейка |
| 6 | empty_plate_salad | Пустая тарелка после салата |
| 7 | empty_plate_soup | Пустая тарелка после супа |
| 8 | empty_plate_cake | Пустая тарелка после торта |
| 9 | cup | Чашка |
| 10 | empty_cup | Пустая чашка |

## Результаты модели

### Лучшая модель (Baseline):
- **mAP@0.5**: 0.988
- **mAP@0.5:0.95**: 0.841
- **Precision**: 0.996
- **Recall**: 0.970
- **F1-score**: 0.983

### Сравнение экспериментов:

| Модель | mAP@0.5 | mAP@0.5:0.95 | Precision | Recall | F1-score | Время обучения |
|--------|---------|--------------|-----------|--------|----------|----------------|
| Baseline | 0.988 | 0.841 | 0.996 | 0.970 | 0.983 | 3.26h |
| Оптимизация 1 | 0.979 | 0.776 | 0.995 | 0.970 | 0.982 | 1.67h |
| Оптимизация 2 | 0.974 | 0.673 | 0.990 | 0.960 | 0.974 | 2.10h |
| Оптимизация 3 | 0.981 | 0.816 | 0.996 | 0.969 | 0.982 | 2.06h |
| Оптимизация 4 | 0.981 | 0.816 | 0.996 | 0.969 | 0.982 | 0.80h |

## Структура проекта

```
dish_recognition/
├── main.py                    # Главный файл с интерактивным меню
├── videos/                    # Исходные видеофайлы
│   ├── video1.mov
│   ├── video2.mov
│   ├── video3.mov
│   ├── video4.mov
│   ├── video5.mov
│   └── video6.mov
├── frames/                    # Извлеченные кадры
├── annotations/               # Аннотации и датасет
│   ├── augmented/
│   │   ├── images/           # Аугментированные изображения
│   │   └── labels/           # Аугментированные аннотации
│   ├── dataset/              # Структурированный датасет
│   │   ├── train/
│   │   ├── val/
│   │   ├── test/
│   │   └── data.yaml
│   └── experiments/          # Результаты экспериментов
├── utils/                    # Вспомогательные модули
│   ├── annotate.py          # Аугментация и проверка аннотаций
│   ├── extract.py           # Извлечение кадров
│   ├── hyperparams.py       # Оптимизация гиперпараметров
│   ├── baseline.py          # Обучение базовой модели
│   ├── dataset.py           # Создание структуры датасета
│   ├── graph.py             # Построение графиков
│   └── video.py             # Создание видео с инференсом
└── README.md
```

## Установка и настройка

### Системные требования

- **GPU**: NVIDIA с поддержкой CUDA
- **RAM**: минимум 16 ГБ
- **Storage**: минимум 20 ГБ свободного места
- **Python**: версия 3.8+

### Установка зависимостей

```bash
pip install ultralytics
pip install albumentations
pip install opencv-python
pip install matplotlib
pip install pandas
pip install scikit-learn
pip install PyYAML
pip install tqdm
```

Или установите все зависимости из requirements.txt:

```bash
pip install -r requirements.txt
```

### Основные зависимости

```
ultralytics==8.3.160
albumentations==2.0.8
opencv-python==4.11.0.86
matplotlib==3.10.3
pandas==2.3.0
scikit-learn==1.7.0
torch==2.7.1+cu128
torchvision==0.22.0+cu128
```

## Подготовка данных

### Исходные данные

Проект использует 6 видеофайлов формата MOV:
- Общая продолжительность: 14 минут 32 секунды
- Разрешение: 1920x1080
- Общее количество извлеченных кадров: 3,177

### Статистика датасета

| Параметр | Значение |
|----------|----------|
| Общее количество изображений | 3,177 |
| Тренировочная выборка | 2,223 (70%) |
| Валидационная выборка | 477 (15%) |
| Тестовая выборка | 477 (15%) |
| Среднее количество объектов на изображение | 5.51 |
| Общее количество аннотаций | 2,628 |

### Распределение классов

| Класс | Количество | Процент |
|-------|------------|---------|
| empty_cup | 603 | 22.9% |
| salad | 363 | 13.8% |
| tea | 358 | 13.6% |
| cake | 347 | 13.2% |
| steak | 281 | 10.7% |
| soup | 234 | 8.9% |
| empty_plate_steak | 187 | 7.1% |
| empty_plate_cake | 142 | 5.4% |
| empty_plate_salad | 129 | 4.9% |
| empty_plate_soup | 116 | 4.4% |
| cup | 113 | 4.3% |

## Использование

### Запуск интерактивного меню

```bash
python main.py
```

Интерактивное меню предоставляет следующие опции:

1. **Извлечение кадров из видео** - извлекает кадры из видеофайлов
2. **Проверка и копирование аннотаций** - проверяет корректность аннотаций
3. **Аугментация данных** - применяет аугментацию к изображениям
4. **Создание структуры датасета** - организует данные для обучения
5. **Обучение базовой модели** - запускает обучение с базовыми параметрами
6. **Оптимизация гиперпараметров (1-я итерация)** - на пустой модели
7. **Оптимизация гиперпараметров (2-я итерация)** - на пустой модели
8. **Оптимизация гиперпараметров (1-я итерация)** - на базовой модели
9. **Оптимизация гиперпараметров (2-я итерация)** - на базовой модели
10. **Построение графиков метрик** - визуализация результатов
11. **Создание видео с инференсом** - применение модели к видео

### Пошаговое воспроизведение

#### 1. Извлечение кадров
```bash
# Выберите опцию 1 в меню
# Кадры будут извлечены в директорию frames/
```

#### 2. Аннотирование (ручное)
- Используйте LabelImg для создания аннотаций
- Формат: YOLO (class_id x_center y_center width height)
- Сохраняйте аннотации в директории annotations/

#### 3. Проверка аннотаций
```bash
# Выберите опцию 2 в меню
# Система проверит корректность и скопирует аннотации
```

#### 4. Аугментация данных
```bash
# Выберите опцию 3 в меню
# Применяется следующая аугментация:
# - HorizontalFlip (p=0.5)
# - RandomBrightnessContrast (p=0.3)
# - Rotate (limit=30, p=0.3)
# - RandomCrop (512x512, p=0.3)
# - Resize (640x640)
```

#### 5. Создание структуры датасета
```bash
# Выберите опцию 4 в меню
# Создается структура train/val/test в соотношении 70:15:15
```

#### 6. Обучение модели
```bash
# Выберите опцию 5 для базовой модели
# Параметры обучения:
# - epochs: 100
# - batch_size: 4
# - image_size: 640x640
# - optimizer: AdamW
# - learning_rate: 0.001
```

## Конфигурация экспериментов

### Базовая модель (Baseline)
```python
baseline_config = {
    "epochs": 100,
    "batch": 4,
    "imgsz": 640,
    "device": 0,
    "workers": 4,
    "patience": 15,
    "optimizer": "AdamW",
    "lr0": 0.001,
    "lrf": 0.0001,
    "momentum": 0.937,
    "weight_decay": 0.0005,
    "cos_lr": True,
    "freeze": 10
}
```

### Оптимизация 1 (SGD оптимизатор)
```python
optimization1_config = {
    "optimizer": "SGD",
    "lr0": 0.005,
    "lrf": 0.00005,
    "momentum": 0.9,
    "degrees": 45.0,
    "translate": 0.3,
    "scale": 1.0,
    "shear": 0.3,
    "mixup": 0.3
}
```

### Оптимизация 2 (Усиленная аугментация)
```python
optimization2_config = {
    "optimizer": "AdamW",
    "lr0": 0.0005,
    "lrf": 0.00001,
    "freeze": 15,
    "degrees": 60.0,
    "translate": 0.4,
    "scale": 0.9,
    "shear": 0.4,
    "perspective": 0.003,
    "mixup": 0.4,
    "hsv_h": 0.025,
    "hsv_s": 0.9,
    "hsv_v": 0.6
}
```


### Оптимизация 3-4 использует те же настройки, что и 1-2, только на модели best.pt baseline9, однако даже это оказывается хуже чем обычная базовая модель

## Анализ результатов

### Производительность по классам

| Класс | Precision | Recall | F1-score | AP@0.5 |
|-------|-----------|--------|----------|--------|
| steak | 1.000 | 0.982 | 0.991 | 0.995 |
| salad | 0.997 | 0.975 | 0.986 | 0.992 |
| soup | 0.995 | 0.964 | 0.979 | 0.989 |
| cake | 0.992 | 0.934 | 0.962 | 0.964 |
| tea | 0.998 | 0.964 | 0.981 | 0.976 |
| empty_plate_steak | 1.000 | 0.978 | 0.989 | 0.992 |
| empty_plate_salad | 0.996 | 0.984 | 0.990 | 0.995 |
| empty_plate_soup | 0.998 | 0.966 | 0.982 | 0.994 |
| cup | 0.994 | 0.982 | 0.988 | 0.993 |
| empty_cup | 0.993 | 0.967 | 0.980 | 0.989 |

### Ключевые выводы

1. **Лучшие классы (AP@0.5 > 0.99)**:
   - steak: 0.995 - отличная детекция благодаря четким контурам
   - empty_plate_salad: 0.995 - хорошо различимые остатки салата
   - empty_plate_soup: 0.994 - характерные следы супа

2. **Сложные классы**:
   - cake: 0.964 - разнообразие форм и украшений
   - tea: 0.976 - схожесть с другими жидкостями

3. **Влияние гиперпараметров**:
   - AdamW превосходит SGD для данной задачи
   - Базовая аугментация эффективнее агрессивной
   - Transfer learning от предобученных весов YOLOv11 оптимален

## Создание видео с инференсом

```bash
# Выберите опцию 11 в меню
# Создается видео inference.mp4 с прорисованными bounding boxes

```
Тестовое видео прикреплено в корневой директории проекта 

## Конфигурационные файлы

### data.yaml
```yaml
train: annotations/dataset/train/images
val: annotations/dataset/val/images
test: annotations/dataset/test/images
nc: 11
names: ['steak', 'salad', 'soup', 'cake', 'tea',
        'empty_plate_steak', 'empty_plate_salad',
        'empty_plate_soup', 'empty_plate_cake',
        'cup', 'empty_cup']
```

## Практическое применение

Достигнутые результаты делают систему готовой для применения в:

- **Автоматизации ресторанного сервиса**
- **Системах контроля качества пищи**
- **Мониторинге пищевого поведения**
- **Исследовательских проектах в области питания**


### Оптимизация производительности

- Используйте SSD для хранения данных
- Увеличьте количество workers при наличии мощного CPU
- Рассмотрите использование mixed precision training



## Авторы

Проект разработан как тестовое задание для позиции Computer Vision Developer. Выполнено Цурик Егором Михайловичем 

## Лицензия
Этот проект создан в образовательных целях все права принадлежат yomorigi aka yomoshio.
